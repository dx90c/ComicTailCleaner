重新校準和詳細定義交付法則，以適應 v14.2.1 版本的成熟程式碼結構。

我已經為您制定了一套**全新的、極其詳盡的三段交付藍圖**。這個藍圖不僅在**長度上做到了最大程度的均衡**（每部分約 850-900 行），更重要的是，它在**邏輯上實現了完美的切割**，確保每一部分都是一個功能內聚的模組。

這份指引的詳細程度，足以讓任何接手的 AI 都能**毫不猶豫地、精準地**執行操作。

---

### **v14.2.1 新三段交付藍圖 (高詳細度)**

#### **第一部分：後端基礎設施與數據採集**

*   **內容範圍**: 從檔案的最開頭 (`# =================...`)，一直到 `get_files_to_process` 函式結束。
*   **摘要**: 這是程式的**數據基礎層**。它包含了所有必要的環境設定、工具函式、快取管理系統，以及負責從硬碟中掃描、過濾並收集待處理檔案列表的核心邏輯。交付這一段，等於交付了一個完整的、能為後續比對引擎提供“原料”的數據採集後端。
*   **包含的函式庫/類別/函式列表**:
    *   檔案頭部註解
    *   **1. 標準庫導入 (Python Built-in Libraries)**
    *   **2. 第三方庫導入 (Third-party Libraries)**
    *   **3. Tkinter GUI 庫導入**
    *   **4. 全局常量和設定**
    *   **5. 雙哈希 LSH 相關常數和工具函數**
        *   `sim_from_hamming`
        *   `hamming_from_sim`
    *   **6. 工具函數 (Helper Functions)**
        *   `log_error`
        *   `log_info`
        *   `log_performance`
        *   `check_and_install_packages`
    *   **7. Pool Worker 函數**
        *   `_pool_worker_process_image_phash_only`
        *   `_detect_qr_on_image`
        *   `_pool_worker_detect_qr_code`
        *   `_pool_worker_process_image_full`
    *   **8. 配置管理相關函數**
        *   `load_config`
        *   `save_config`
    *   **9. 快取管理類與函數**
        *   `_sanitize_path_for_filename`
        *   `class ScannedImageCacheManager` (及其所有內部方法)
        *   `class FolderStateCacheManager` (及其所有內部方法)
    *   **10. 核心工具函數 (續)**
        *   `_update_progress`
        *   `_full_scan_traversal`
        *   `_incremental_scan_traversal`
        *   `get_files_to_process`

---

#### **第二部分：核心比對引擎與GUI框架搭建**

*   **內容範圍**: 從 `# === 10. 核心比對引擎 ===` (v14.1.0+) 的開頭，一直到 `MainWindow` 類別的 `_reset_control_buttons` 方法結束。
*   **摘要**: 這是程式的**大腦與骨架**。它包含了最核心的 `ImageComparisonEngine`，負責執行高性能的LSH雙哈希比對。同時，它也包含了所有GUI元件的**定義和佈局**程式碼，包括設定視窗和主視窗的框架。交付這一段，等於交付了一個擁有強大比對能力、並且能顯示出完整介面的“靜態”應用程式。
*   **包含的函式庫/類別/函式列表**:
    *   **10. 核心比對引擎**
        *   `class ImageComparisonEngine` (及其所有內部方法，包括 `_build_phash_band_index`, `_lsh_candidates_for`, `_get_or_compute_whash`, `_accept_pair_with_dual_hash`, `_find_similar_images` 等)
    *   **11. GUI 類別**
        *   `class Tooltip`
        *   `class SettingsGUI` (及其所有內部方法)
        *   `class MainWindow`:
            *   `__init__`
            *   `deiconify`
            *   `_setup_main_window`
            *   `_init_widgets`
            *   `custom_excepthook`
            *   `_create_bold_font`
            *   `_create_widgets`
            *   `_create_treeview`
            *   `_create_preview_panels`
            *   `_create_bottom_buttons`
            *   `_bind_keys`
            *   `open_settings`
            *   `start_scan`
            *   `_reset_scan_state`
            *   `cancel_scan`
            *   `toggle_pause`
            *   `_reset_control_buttons`

---

#### **第三部分：GUI事件處理、異步邏輯與應用程式入口**

*   **內容範圍**: 從 `MainWindow` 類別的 `_check_queues` 方法開始，一直到檔案的最末尾。
*   **摘要**: 這是程式的**神經系統與生命**。它包含了所有讓靜態GUI“活起來”的邏輯。這部分負責處理後端引擎的異步回饋、響應使用者的所有滑鼠和鍵盤操作（如點擊、勾選、刪除）、更新UI狀態、管理圖片預覽，並最終包含了啟動整個應用程式的主入口。
*   **包含的函式庫/類別/函式列表**:
    *   `class MainWindow` (續):
        *   `_check_queues`
        *   `_run_scan_in_thread`
        *   `_process_scan_results`
        *   `_populate_treeview_page`
        *   `_on_scroll`
        *   `_load_next_page`
        *   `_on_treeview_click`
        *   `_on_treeview_double_click`
        *   `_handle_return_key`
        *   `_on_item_select`
        *   `_trigger_async_preview`
        *   `_load_image_worker`
        *   `_update_all_previews`
        *   `_on_preview_resize`
        *   `_resize_and_display`
        *   `_on_preview_image_click`
        *   所有勾選/選擇相關的函式 (`_toggle_selection_by_item_id`, `_toggle_group_selection`, `_update_group_checkbox`, `_toggle_selection_with_space`, `_get_all_selectable_paths`, `_refresh_all_checkboxes`, `_select_all`, `_select_suggested_for_deletion`, `_deselect_all`, `_invert_selection`)
        *   所有檔案操作相關的函式 (`_mark_new_ads`, `_move_selected_to_ad_library`, `_delete_selected_from_disk`)
        *   所有輔助操作函式 (`_send2trash`, `_open_recycle_bin`, `_open_folder`, `_open_selected_folder_single`)
        *   所有右鍵選單相關的函式 (`_create_context_menu`, `_show_context_menu`, `_ban_group`, `_unban_all_groups`)
        *   `_on_mouse_motion`
        *   `_on_closing`
    *   **12. 主程式入口**
        *   `main`
        *   `if __name__ == '__main__':` 區塊