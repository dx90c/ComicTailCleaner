### **ComicTailCleaner 開發計畫與交接文件 (v16.0.2 發布版)**

**致所有協作者 (包括 AI)：**

您好，歡迎加入 ComicTailCleaner 專案。本文件記錄了專案的架構演進、當前穩定版本的狀態，以及未來的開發願景。

**目前狀態**：**v16.0.2 (Stable)** 已發布。此版本完成了核心數據層的 SQLite 遷移、GUI 的初步模組化拆分，以及外掛系統的資源共享重構。

---

### **一、開發路線圖 (Development Roadmap)**

本專案採用語義化版本號。

#### **v15.x 系列 (已完成)**
*   **v15.0.0**: 確立了 src 目錄結構，修復了檔案掃描與進度條的核心缺陷，確保了打包後的路徑穩定性。

#### **v16.x 系列 (架構重構與效能優化 - 當前階段)**

*   **v16.0.2 (已完成 - 當前版本)**:
    *   **核心重構**: **快取系統 SQLite 化**。棄用 JSON，改用 SQLite (WAL 模式) 管理圖片與資料夾快取，徹底解決大數據量下的 I/O 瓶頸與併發寫入風險。
    *   **外掛架構**: **共享核心引擎**。`manga_deduplication` 外掛現在直接呼叫核心引擎的公開 API (`compute_phashes`)，避免重複運算。
    *   **設定管理**: 實作 `get_default_config` 機制，主程式可自動偵測並合併外掛的預設設定，實現設定檔 (`config.json`) 的自動化管理。
    *   **GUI 模組化**: 將龐大的 `gui.py` 拆分為 `gui/` 套件，獨立出 `settings_window.py` 與 `tooltip.py`。
    *   **EH 工具修復**: 完善 `eh_database_tools` 的備份輪替機制、修正 CSV 欄位錯位，並強化自動化流程的防禦性 (Try-Except)。

#### **未來展望 (v16.x 後續 / v17.x)**

*   **v16.1.0 (規劃中)**:
    *   **核心目標**: **GUI 與邏輯徹底分離 (Controller 模式)**。
    *   **待實現**:
        *   建立 `core/app_controller.py`。
        *   將檔案操作 (刪除/複製)、掃描執行緒管理等邏輯從 `main_window.py` 移至 Controller。
        *   進一步拆分 GUI 元件：將圖片預覽區獨立為 `gui/components/preview_panel.py`。

*   **v16.2.0 (規劃中)**:
    *   **核心目標**: **日誌系統與自動化增強**。
    *   **待實現**:
        *   引入 `RotatingFileHandler` 實現日誌輪替，防止 log 檔案無限膨脹。
        *   評估將 `eh_database_tools` 的自動化底層從 `pyautogui` (圖像識別) 遷移至 `pywinauto` (控制代碼)，以提升抗干擾能力。

*   **v17.0.0 (長期目標)**:
    *   **核心目標**: **GUI 框架現代化**。
    *   **待實現**: 評估遷移至 `PyQt6` 或 `PySide6`，以獲得更佳的 HiDPI 支援與現代化控制項。

---

### **二、v16.0.2 架構與實現細節**

#### **1. 數據持久層 (SQLite Transition)**
*   **變更**: `processors/scanner.py` 已升級為 v3.0.0。
*   **機制**: `ScannedImageCacheManager` 與 `FolderStateCacheManager` 繼承自 `SQLiteCacheBase`。
*   **兼容性**: 程式啟動時會自動偵測舊版 `.json` 快取並遷移至 `.db`，無需使用者手動操作。

#### **2. 外掛系統 (Plugin System)**
*   **設定自動化**: `BasePlugin` 新增 `get_default_config()` 介面。`gui/main_window.py` 在啟動時會收集所有外掛設定並寫入 `config.json`。
*   **資源共享**: 外掛透過呼叫 `engine.compute_phashes(...)` 利用主程式的執行緒池與快取，不再私自維護掃描邏輯。
*   **路徑規範**: `config.py` 定義了全域唯一的 `DATA_DIR`，所有外掛產出的檔案（備份、CSV、快取）皆統一存放在 `data/` 或其子目錄下。

#### **3. 專案結構 (Directory Structure)**
v16.0.2 引入了新的 GUI 套件結構，開發者需注意檔案位置的變更：

```text
src/
├── app.py                  # 程式入口 (負責依賴檢查與啟動)
├── config.py               # 全域設定與路徑定義 (DATA_DIR)
├── core_engine.py          # 核心比對與哈希計算邏輯
├── gui/                    # [新] GUI 套件
│   ├── __init__.py
│   ├── main_window.py      # [原 gui.py] 主視窗 (已瘦身)
│   ├── settings_window.py  # [新] 獨立的設定視窗
│   └── components/         # GUI 元件
│       └── tooltip.py
├── plugins/                # 外掛目錄
│   ├── manga_deduplication/
│   └── eh_database_tools/
└── processors/             # 邏輯處理器
    └── scanner.py          # [v3.0] SQLite 快取管理器
```

---

### **三、模組化協作原則 (Updated)**

#### **核心模組職責劃分**

*   **`gui/main_window.py`**
    *   **職責**: 負責主視窗的佈局、事件綁定。目前仍包含部分業務邏輯（如檔案刪除），未來版本將逐步移出。
    *   **修改原則**: 盡量僅處理「顯示」相關邏輯。

*   **`gui/settings_window.py`**
    *   **職責**: 獨立負責設定介面的繪製與 `config.json` 的保存。
    *   **注意**: 初始化外掛設定 UI 時，需確保在 `__init__` 階段完成，避免 `KeyError`。

*   **`core_engine.py`**
    *   **職責**: 提供公開 API (`compute_phashes`) 供內部與外掛呼叫。
    *   **修改原則**: 保持 API 簽名穩定，任何對 `_process_images_with_cache` 的修改都需確保不破壞外掛的呼叫。

*   **`plugins/`**
    *   **命名規範**: 外掛的設定鍵值 (`config` key) **必須**加上前綴（如 `manga_dedupe_...`），嚴禁與主程式或其他外掛衝突。
    *   **路徑規範**: 嚴禁外掛自行推算路徑，必須引用 `config.DATA_DIR`。

*   **`requirements.txt` (自動生成)**
    *   由 `dependency_manager.py` 在啟動時自動掃描生成，開發者無需手動維護。

---

**交接結語：**
v16.0.2 是一個架構健康、效能優異的穩定版本。接下來的開發工作（v16.1+）建議聚焦於「程式碼整潔度」與「邏輯分離」，在不破壞現有穩定性的前提下，逐步將 `main_window.py` 轉型為純粹的 View 層。