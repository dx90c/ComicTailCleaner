### **ComicTailCleaner 開發計畫與交接文件 (v16.0.0 規劃版)**

**致所有協作者 (包括 AI)：**

您好，歡迎加入 ComicTailCleaner 專案。為確保所有開發工作都能在一個清晰、統一的框架下進行，請在開始任何工作前，仔細閱讀本文件。

本文件包含了專案的長期開發路線圖、各版本的主要里程碑，以及我們為確保在模組化架構下高效協作而制定的開發原則。

---

### **一、開發路線圖 (Development Roadmap)**

本專案採用語義化版本號。`v14.x` 系列完成了核心引擎的重構與模組化，`v15.x` 系列專注於架構的全面穩定與精煉，而 `v16.x` 系列將著眼於架構的進一步優化與現代化。

#### **v14.x 系列 (核心引擎重構與功能擴展)**

*   **v14.4.0 (已完成)**: 專案完全模組化，並首次實現了對壓縮檔的直接掃描支援。
*   **v15.0.0 (已完成 - 當前穩定版)**:
    *   **核心**: **架構穩定性與可靠性**。此版本是繼模組化後最重要的一次穩定性更新，徹底解決了檔案掃描「爆量」、打包後外掛失效、進度條失準等多個核心缺陷，並對性能進行了顯著優化。

#### **v16.x 系列 (架構優化與未來展望)**

*   **v16.0.0 (當前規劃中)**:
    *   **核心目標**: **外掛系統架構重構 (共享核心引擎)**。
    *   **待實現**: 將外掛模組從目前的「完全獨立引擎」模式，重構為「共享核心引擎」模式，以根除程式碼重複、簡化長期維護。

*   **v16.1.0 (待規劃)**:
    *   **核心目標**: **GUI 框架現代化遷移**。
    *   **待實現**: 評估並將目前的 `tkinter` GUI 框架，遷移至更現代的框架（如 `PyQt6` 或 `PySide6`）。

*   **v16.2.0 (待規劃)**:
    *   **核心目標**: **錯誤恢復與使用者自訂功能**。
    *   **待實現**:
        *   **中斷點續掃**: 允許使用者從上次意外中斷的地方繼續掃描。
        *   **使用者回饋學習**: 引入機制，允許使用者標記誤判結果。

---

### **二、實現細節 (v16.0.0 規劃)**

#### **v16.0.0: 外掛系統架構重構 (共享核心引擎)**

*   **目標**: 讓所有外掛不再維護自己獨立的掃描引擎副本，而是直接呼叫主程式 `core_engine.py` 中經過充分測試的 `get_files_to_process` 函式來獲取檔案列表。外掛本身只專注於其獨特的**比對邏輯**。

*   **實現步驟**:
    1.  **重構外掛 `processor.py`**:
        *   **移除重複程式碼**: 刪除外掛內部所有與 `core_engine` 重複的掃描相關函式，包括 `_plugin_scan_traversal`, `_iter_scandir_recursively` 等。
        *   **導入核心掃描器**: 在外掛的 `processor.py` 頂部，新增 `from core_engine import get_files_to_process`。
    2.  **改造外掛的 `run` 方法**:
        *   外掛的 `run` 方法將不再自己遍歷檔案系統。取而代之，它會：
            a.  準備一個符合自己需求的 `config` 字典（例如，將 `extract_count` 設定為其 UI 上的「末尾圖片取樣數」）。
            b.  直接呼叫 `files_to_process, _ = get_files_to_process(plugin_config, ...)` 來獲取檔案列表。
            c.  接收到檔案列表後，繼續執行其後續獨有的邏輯（如計算哈希、建立指紋、比對指紋等）。
    3.  **調整快取策略**:
        *   確保外掛在呼叫 `get_files_to_process` 時，傳入一個具有獨特 `comparison_mode` 名稱的 `ScannedImageCacheManager` 實例（例如 `plugin_manga_dedup`），以維持快取的隔離性。

*   **預期收益**:
    *   **單一事實來源 (Single Source of Truth)**：所有檔案掃描、快取判斷、排除邏輯都集中在 `core_engine.py` 中，不再有多個版本。
    *   **維護極簡化**: 未來對主掃描引擎的任何優化或錯誤修正（例如支援新的壓縮檔格式），所有外掛將**自動受益**，無需再手動同步程式碼。
    *   **行為完全一致**: 確保所有內建模式和外掛模式在「如何獲取檔案」這一基礎步驟上，行為完全相同，從根本上消除因邏輯不一致而產生的潛在 Bug。

---

### **三、模組化協作原則 (Modular Collaboration Principles)**

（此部分保持不變，它為 v16.0.0 的重構提供了理論基礎和指導方針）

#### **核心模組職責劃分**

*   **`app.py` (應用程式入口)**
    *   **職責**: 唯一入口。負責環境設定、依賴檢查、建立 `MainWindow` 實例並啟動主迴圈。
    *   **修改原則**: **極少修改**。

*   **`gui.py` (使用者介面層)**
    *   **職責**: 所有視覺元件、使用者互動事件的綁定與處理。
    *   **修改原則**: 專注於 UI/UX，不應包含任何實際的比對或檔案掃描邏輯。

*   **`core_engine.py` (核心引擎層)**
    *   **職責**: 核心演算法的實現，是所有掃描和比對邏輯的**唯一**來源。
    *   **修改原則**: 這是專案的心臟，任何變更都應考慮其對所有內建模式和**所有外掛**的影響。

*   **`processors/` (處理器/控制器層)**
    *   **職責**: 作為 `gui.py` 和 `core_engine.py` 之間的「協調者」。
    *   **修改原則**: 新增內建模式時的擴展點。

*   **`plugins/` (外掛擴展層)**
    *   **職責**: 提供獨立、可選的功能模組。**v16.0.0 後，外掛應專注於實現獨特的比對邏輯，並呼叫核心引擎來處理通用的檔案掃描任務。**
    *   **修改原則**: 最推薦的功能擴展方式。

*   **`utils.py`, `config.py`, `archive_handler.py` (基礎設施層)**
    *   **職責**: 提供全域設定、通用工具函式和壓縮檔處理能力。
    *   **修改原則**: 新增通用功能時可在此處擴充。

#### **協作流程建議**

1.  **修改前確認影響範圍**: 在修改任何一個模組前，請先思考其職責與影響範圍。
2.  **優先透過外掛擴展**: 當需要一個全新的功能時，首選方案是建立一個新的外掛。
3.  **保持接口穩定**: `BasePlugin` 和 `BaseProcessor` 的 `run()` 方法簽名是模組間的「契約」，應避免輕易改動。